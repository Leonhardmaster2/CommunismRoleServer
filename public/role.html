<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comrade - Kulturrevolution</title>
  <link rel="stylesheet" href="/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="role-page">
    <div class="container" id="gameContainer">
      <div class="role-header">
        <div class="flag-icon">üö©</div>
        <h1 class="title">Comrade <span id="playerName" class="player-name-display"></span></h1>
        <div id="roleBadge" class="role-badge">Revolutionary</div>
      </div>

      <div class="task-container">
        <div id="status" class="status">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <p>Waiting for your secret task...</p>
        </div>
        <div id="taskCard" class="task-card hidden">
          <div class="task-type-badge" id="taskTypeBadge"></div>
          <div class="task-content" id="task"></div>
        </div>
      </div>

      <!-- Suspicion Chart -->
      <div id="suspicionChart" class="suspicion-chart hidden">
        <h3 class="chart-title">üìä Suspicion Levels</h3>
        <div id="chartBars" class="chart-bars"></div>
      </div>

      <!-- Voting Section -->
      <div id="votingSection" class="voting-section hidden">
        <h3 class="voting-title">üó≥Ô∏è Cast Your Vote</h3>
        <p class="voting-subtitle">Who do you think is the imposter?</p>
        <div id="voteButtons" class="vote-buttons"></div>
        <div id="voteStatus" class="vote-status hidden"></div>
      </div>
    </div>
  </div>

  <script>
    // Get player ID from URL
    const pathParts = window.location.pathname.split('/');
    const playerID = pathParts[pathParts.length - 1];

    let playerName = '';
    let currentVote = null;
    let allPlayers = [];

    // Connect to Socket.IO
    const socket = io();

    // Register with server
    socket.on('connect', () => {
      console.log('Connected to server');
      socket.emit('register', playerID);
    });

    // Handle player info
    socket.on('playerInfo', (info) => {
      playerName = info.name;
      document.getElementById('playerName').textContent = info.name;
    });

    // Handle new task
    socket.on('newTask', (data) => {
      const statusEl = document.getElementById('status');
      const taskCard = document.getElementById('taskCard');
      const taskEl = document.getElementById('task');
      const typeBadge = document.getElementById('taskTypeBadge');
      const roleBadge = document.getElementById('roleBadge');

      // Hide loading status
      statusEl.classList.add('hidden');

      // Set task content
      taskEl.textContent = data.task;

      // Set role and task type badge
      if (data.type === 'hunter') {
        typeBadge.textContent = 'üîç DETECTIVE';
        typeBadge.className = 'task-type-badge hunter';
        taskCard.className = 'task-card hunter';
        roleBadge.textContent = 'üîç DETECTIVE';
        roleBadge.className = 'role-badge detective';
      } else if (data.type === 'target') {
        typeBadge.textContent = 'üé≠ IMPOSTER';
        typeBadge.className = 'task-type-badge target';
        taskCard.className = 'task-card target';
        roleBadge.textContent = 'üé≠ IMPOSTER';
        roleBadge.className = 'role-badge imposter';
      } else {
        typeBadge.textContent = '‚≠ê COMRADE';
        typeBadge.className = 'task-type-badge comrade';
        taskCard.className = 'task-card comrade';
        roleBadge.textContent = '‚≠ê COMRADE';
        roleBadge.className = 'role-badge comrade';
      }

      // Show task card with animation
      taskCard.classList.remove('hidden');
      setTimeout(() => {
        taskCard.classList.add('show');
      }, 10);

      // Show voting and suspicion sections
      document.getElementById('votingSection').classList.remove('hidden');
      document.getElementById('suspicionChart').classList.remove('hidden');
    });

    // Handle suspicion updates
    socket.on('suspicionUpdate', (suspicionData) => {
      updateSuspicionChart(suspicionData);
      updateVoteButtons(suspicionData);
    });

    // Update suspicion chart
    function updateSuspicionChart(data) {
      const chartBars = document.getElementById('chartBars');
      if (!data || data.length === 0) {
        chartBars.innerHTML = '<p class="no-data">No data yet...</p>';
        return;
      }

      const maxSuspicion = Math.max(...data.map(p => p.suspicion), 1);

      chartBars.innerHTML = data.map(player => {
        const percentage = (player.suspicion / maxSuspicion) * 100;
        const isCurrentPlayer = player.id === playerID;
        return `
          <div class="chart-bar-row ${isCurrentPlayer ? 'current-player' : ''}">
            <div class="chart-label">${player.name}</div>
            <div class="chart-bar-container">
              <div class="chart-bar" style="width: ${percentage}%">
                <span class="chart-value">${player.votes} vote${player.votes !== 1 ? 's' : ''}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update vote buttons
    function updateVoteButtons(suspicionData) {
      allPlayers = suspicionData || [];
      const voteButtons = document.getElementById('voteButtons');

      const otherPlayers = allPlayers.filter(p => p.id !== playerID);

      if (otherPlayers.length === 0) {
        voteButtons.innerHTML = '<p class="no-players">No other players to vote for</p>';
        return;
      }

      voteButtons.innerHTML = otherPlayers.map(player => {
        const isVoted = currentVote === player.id;
        return `
          <button class="vote-btn ${isVoted ? 'voted' : ''}" onclick="castVote('${player.id}')">
            ${isVoted ? '‚úì ' : ''}${player.name}
          </button>
        `;
      }).join('');
    }

    // Cast vote
    function castVote(targetID) {
      currentVote = targetID;
      socket.emit('castVote', targetID);
    }

    // Handle vote confirmation
    socket.on('voteConfirmed', (data) => {
      const voteStatus = document.getElementById('voteStatus');
      voteStatus.textContent = `You voted for ${data.target}`;
      voteStatus.classList.remove('hidden');

      // Update button styles
      updateVoteButtons(allPlayers);
    });

    // Handle elimination
    socket.on('dead', (data) => {
      const container = document.getElementById('gameContainer');
      container.innerHTML = `
        <div class="eliminated">
          <div class="skull-animation">‚ò†Ô∏è</div>
          <h2>You have been eliminated</h2>
          <div class="revealed-role ${data.revealedRole.toLowerCase()}">${data.revealedRole}</div>
          <p class="eliminated-name">${playerName}</p>
          ${data.wasActualImposter ?
            '<p class="truth">You were caught! The revolutionaries win.</p>' :
            '<p class="truth">You were innocent! They got the wrong person.</p>'
          }
        </div>
      `;
    });

    // Handle system messages
    socket.on('systemMessage', (message) => {
      showNotification(message);
    });

    // Handle game reset
    socket.on('gameReset', () => {
      location.reload();
    });

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.innerHTML = `
        <div class="notification-icon">üì¢</div>
        <div class="notification-text">${message}</div>
      `;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('show');
      }, 10);

      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 5000);
    }

    // Handle connection errors
    socket.on('connect_error', (error) => {
      console.error('Connection error:', error);
      showNotification('Connection error. Please check your connection.');
    });
  </script>
</body>
</html>
